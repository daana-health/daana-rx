<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DaanaRX</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@0.395.0/dist/umd/lucide-react.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- QR Code Generator Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .btn-disabled { background-color: #9ca3af; cursor: not-allowed; }
        .app-view { min-height: 400px; }
        
        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; 
            z-index: 50; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgb(0,0,0); 
            background-color: rgba(0,0,0,0.4); 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; padding-bottom: 16px; }
        .modal-title { font-size: 1.25rem; font-weight: 600; }
        .modal-close { cursor: pointer; font-size: 1.5rem; color: #9ca3af; }
        
        /* Quick Chip Style */
        .ndc-chip {
            display: inline-block;
            padding: 6px 12px;
            margin: 4px;
            background-color: #e0e7ff;
            color: #4338ca;
            border-radius: 16px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .ndc-chip:hover {
            background-color: #c7d2fe;
        }

        /* Print-specific styles for the label */
        @media print {
            body * {
                visibility: hidden; /* Hide everything by default */
            }
            #print-label-content, #print-label-content * {
                visibility: visible; /* Show only the label content */
            }
            #print-label-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                padding: 0;
                margin: 0;
            }
            #print-label-modal .modal-content {
                border: none;
                box-shadow: none;
                padding: 0;
                margin: 0;
            }
            /* Hide modal buttons when printing */
            #print-label-modal-footer {
                display: none;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-gray-100 p-6 rounded-2xl shadow-xl">
        
        <!-- Header -->
        <div class="grid grid-cols-3 items-center pb-4 border-b border-gray-300">
            <div class="col-span-1"></div> <!-- Empty spacer -->
            <h1 class="text-3xl font-bold text-gray-800 text-center col-span-1">DaanaRX</h1>
            <div class="text-sm text-gray-600 col-span-1 text-right">
                Status: <span id="app-status" class="font-medium">Initializing...</span>
            </div>
        </div>

        <!-- Mini Status Bar -->
        <div id="status-bar" class="flex flex-wrap gap-x-6 gap-y-2 py-4 border-b border-gray-300 mb-6 bg-white rounded-lg px-4 shadow-sm">
            <div>
                <span class="text-sm text-gray-500">In Stock:</span>
                <span id="stat-in-stock" class="text-lg font-bold text-green-600">...</span>
            </div>
            <div>
                <span class="text-sm text-gray-500">Expiring Soon (90d):</span>
                <span id="stat-expiring" class="text-lg font-bold text-yellow-600">...</span>
            </div>
            <div>
                <span class="text-sm text-gray-500">Checked Out (24h):</span>
                <span id="stat-checked-out" class="text-lg font-bold text-blue-600">...</span>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="app-content">
            
            <!-- Home View -->
            <div id="view-home" class="app-view">
                <!-- Main three buttons -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <button id="nav-check-in" class="bg-white text-green-700 p-10 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 flex flex-col items-center justify-center">
                        <span id="icon-check-in"></span>
                        <h2 class="text-2xl font-semibold mt-3">Check In</h2>
                    </button>
                    <button id="nav-check-out" class="bg-white text-yellow-700 p-10 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 flex flex-col items-center justify-center">
                        <span id="icon-check-out"></span>
                        <h2 class="text-2xl font-semibold mt-3">Check Out</h2>
                    </button>
                    <button id="nav-scan" class="bg-white text-blue-700 p-10 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 flex flex-col items-center justify-center">
                        <span id="icon-scan"></span>
                        <h2 class="text-2xl font-semibold mt-3">Scan / Lookup</h2>
                    </button>
                </div>
                <!-- Secondary buttons -->
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <button id="nav-inventory" class="bg-white text-indigo-700 p-6 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 flex flex-col items-center justify-center">
                        <span id="icon-inventory"></span>
                        <h2 class="text-xl font-semibold mt-2">Inventory</h2>
                    </button>
                    <button id="nav-reports" class="bg-white text-purple-700 p-6 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 flex flex-col items-center justify-center">
                        <span id="icon-reports"></span>
                        <h2 class="text-xl font-semibold mt-2">Reports</h2>
                    </button>
                    <button id="nav-admin" class="bg-white text-gray-700 p-6 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 flex flex-col items-center justify-center">
                        <span id="icon-admin"></span>
                        <h2 class="text-xl font-semibold mt-2">Admin</h2>
                    </button>
                </div>
            </div>

            <!-- Back Button Template (to be cloned) -->
            <button id="back-button-template" class="hidden btn-back mb-4 bg-gray-600 text-white py-2 px-4 rounded-md shadow hover:bg-gray-700">&larr; Back to Home</button>

            <!-- Check In View -->
            <div id="view-check-in" class="app-view hidden space-y-6">
                <button class="btn-back mb-4 bg-gray-600 text-white py-2 px-4 rounded-md shadow hover:bg-gray-700">&larr; Back to Home</button>
                <h2 class="text-2xl font-semibold text-gray-800">Check In Stock</h2>
                
                <!-- Step 1: Add Lot -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Step 1: Create a New Lot</h3>
                    <form id="form-add-lot" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="lot-date" class="block text-sm font-medium text-gray-700">Date Received</label>
                                <input type="date" id="lot-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <div>
                                <label for="lot-source" class="block text-sm font-medium text-gray-700">Source/Donor</label>
                                <input type="text" id="lot-source" placeholder="e.g., Main Donation" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                        </div>
                        <div>
                            <label for="lot-notes" class="block text-sm font-medium text-gray-700">Notes</label>
                            <textarea id="lot-notes" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Optional notes..."></textarea>
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md shadow hover:bg-green-700">Create Lot</button>
                    </form>
                </div>

                <!-- Step 2: Add Unit -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Step 2: Add Units to Lot</h3>
                    
                    <!-- NDC Scan Section -->
                    <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <label for="ndc-scan-input" class="block text-sm font-medium text-gray-700">Scan Manufacturer NDC</label>
                        <p class="text-xs text-gray-500 mb-2">Scan the barcode on the bottle to auto-fill drug info.</p>
                        <div class="flex gap-2">
                            <input type="text" id="ndc-scan-input" placeholder="Enter NDC (e.g., 0071-0570-23)" class="flex-grow block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <button type="button" id="btn-ndc-lookup" class="bg-blue-600 text-white py-2 px-4 rounded-md shadow hover:bg-blue-700">Lookup</button>
                        </div>
                        <p id="ndc-lookup-status" class="text-sm text-gray-600 mt-2"></p>
                        
                        <!-- NEW: Friendly Fallback Section -->
                        <div id="ndc-fallback-search" class="hidden mt-4 pt-4 border-t border-blue-200">
                            <label for="ndc-name-search" class="block text-sm font-medium text-gray-700">Or, search your local formulary by generic name:</label>
                            <input type="text" id="ndc-name-search" placeholder="e.g., Fluoxetine" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            <div id="ndc-search-chips" class="mt-2 flex flex-wrap gap-2">
                                <!-- Chips will be rendered here -->
                            </div>
                            <button type="button" id="btn-enter-manually" class="mt-3 text-sm text-gray-600 underline hover:text-gray-800">Enter Manually Instead</button>
                        </div>
                    </div>

                    <form id="form-add-unit" class="space-y-4">
                        <div>
                            <label for="unit-lot-id" class="block text-sm font-medium text-gray-700">Selected Lot</label>
                            <select id="unit-lot-id" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">-- Select a Lot --</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="unit-generic-name" class="block text-sm font-medium text-gray-700">Generic Name</label>
                                <input type="text" id="unit-generic-name" placeholder="e.g., Amoxicillin" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50" readonly required>
                            </div>
                            <div>
                                <label for="unit-strength" class="block text-sm font-medium text-gray-700">Strength</label>
                                <input type="text" id="unit-strength" placeholder="e.g., 500 mg" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50" readonly required>
                            </div>
                            <div>
                                <label for="unit-form" class="block text-sm font-medium text-gray-700">Form</label>
                                <input type="text" id="unit-form" placeholder="e.g., Capsule" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50" readonly required>
                            </div>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="unit-brand-name" class="block text-sm font-medium text-gray-700">Brand Name</label>
                                <input type="text" id="unit-brand-name" placeholder="e.g., Amoxil" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50" readonly>
                            </div>
                            <div>
                                <label for="unit-ndc" class="block text-sm font-medium text-gray-700">NDC</label>
                                <input type="text" id="unit-ndc" placeholder="e.g., 12345-678-90" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50" readonly>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="unit-qty" class="block text-sm font-medium text-gray-700">Total Quantity</label>
                                <input type="number" id="unit-qty" placeholder="Enter Qty" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                            </div>
                            <div>
                                <label for="unit-exp" class="block text-sm font-medium text-gray-700">Expiry Date</label>
                                <input type="date" id="unit-exp" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                            </div>
                            <div>
                                <label for="unit-location" class="block text-sm font-medium text-gray-700">Location</label>
                                <select id="unit-location" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                                    <option value="">-- Select a Location --</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md shadow hover:bg-blue-700">Add Unit & Generate DaanaRX Label</button>
                    </form>
                </div>
            </div>

            <!-- Check Out View -->
            <div id="view-check-out" class="app-view hidden">
                <button class="btn-back mb-4 bg-gray-600 text-white py-2 px-4 rounded-md shadow hover:bg-gray-700">&larr; Back to Home</button>
                <h2 class="text-2xl font-semibold text-gray-800">Check Out Stock</h2>
                
                <div class="bg-white p-6 rounded-lg shadow max-w-lg mx-auto">
                    <form id="form-check-out" class="space-y-4">
                        <div>
                            <label for="checkout-unit-id" class="block text-sm font-medium text-gray-700">Scan DaanaRX Unit ID</label>
                            <input type="text" id="checkout-unit-id" placeholder="Scan internal DaanaRX QR" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label for="checkout-qty" class="block text-sm font-medium text-gray-700">Quantity to Dispense</label>
                            <input type="number" id="checkout-qty" placeholder="e.g., 10" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                         <div>
                            <label for="checkout-patient-ref" class="block text-sm font-medium text-gray-700">Patient Ref Code (No PHI)</label>
                            <input type="text" id="checkout-patient-ref" placeholder="e.g., JAX-2025-001" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                        <div>
                            <label for="checkout-reason" class="block text-sm font-medium text-gray-700">Reason/Notes</label>
                            <textarea id="checkout-reason" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., Provider dispense"></textarea>
                        </div>
                        <button type="submit" class="w-full bg-yellow-600 text-white py-2 px-4 rounded-md shadow hover:bg-yellow-700">Dispense Stock</button>
                    </form>
                </div>
            </div>

            <!-- Scan View -->
            <div id="view-scan" class="app-view hidden">
                <button class="btn-back mb-4 bg-gray-600 text-white py-2 px-4 rounded-md shadow hover:bg-gray-700">&larr; Back to Home</button>
                <h2 class="text-2xl font-semibold text-gray-800">Scan / Lookup</h2>
                
                <!-- Simulated Scan Input -->
                <div class="max-w-md mx-auto bg-white p-6 rounded-lg shadow mb-6">
                    <p class="text-sm text-gray-600 mb-2">Simulate camera scan by entering a Unit ID below. In a real app, this would be a camera view.</p>
                    <form id="form-scan-lookup" class="flex gap-2">
                        <input type="text" id="scan-input" placeholder="Enter DaanaRX Unit ID (e.g., UNIT-123...)" class="flex-grow block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <button type="submit" id="btn-scan-lookup" class="bg-blue-600 text-white py-2 px-4 rounded-md shadow hover:bg-blue-700">Lookup</button>
                    </form>
                </div>
                
                <!-- Scan Results -->
                <div id="scan-results" class="max-w-md mx-auto">
                    <!-- IF FOUND -->
                    <div id="scan-result-found" class="hidden bg-white p-6 rounded-lg shadow space-y-4">
                        <h3 id="scan-found-med" class="text-2xl font-bold text-gray-900"></h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <span class="block text-sm font-medium text-gray-500">Qty Remaining</span>
                                <span id="scan-found-qty" class="text-lg font-semibold"></span>
                            </div>
                            <div>
                                <span class="block text-sm font-medium text-gray-500">Status</span>
                                <span id="scan-found-status" class="text-lg font-semibold"></span>
                            </div>
                            <div>
                                <span class="block text-sm font-medium text-gray-500">Expires</span>
                                <span id="scan-found-exp" class="text-lg font-semibold"></span>
                            </div>
                             <div>
                                <span class="block text-sm font-medium text-gray-500">Location</span>
                                <span id="scan-found-loc" class="text-lg font-semibold"></span>
                            </div>
                        </div>
                        <!-- Contextual Buttons -->
                        <div class="border-t pt-4 space-y-3">
                            <button id="btn-scan-found-checkout" class="w-full bg-green-600 text-white py-3 px-4 rounded-md shadow hover:bg-green-700 text-lg font-medium">Check Out This Item</button>
                            <button id="btn-scan-found-move" class="w-full bg-gray-500 text-white py-2 px-4 rounded-md shadow hover:bg-gray-600 btn-disabled" disabled>Move (Not Implemented)</button>
                            <button id="btn-scan-found-adjust" class="w-full bg-gray-500 text-white py-2 px-4 rounded-md shadow hover:bg-gray-600 btn-disabled" disabled>Adjust (Not Implemented)</button>
                            <button id="btn-scan-found-history" class="w-full bg-gray-500 text-white py-2 px-4 rounded-md shadow hover:bg-gray-600 btn-disabled" disabled>View History (Not Implemented)</button>
                        </div>
                    </div>
                    
                    <!-- IF NOT FOUND -->
                    <div id="scan-result-not-found" class="hidden bg-white p-6 rounded-lg shadow text-center space-y-4">
                        <h3 class="text-xl font-semibold text-red-600">Unit Not Found</h3>
                        <p id="scan-error-msg" class="text-gray-600"></p>
                        <button id="btn-scan-not-found-checkin" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md shadow hover:bg-blue-700 text-lg font-medium">Check In as New Item?</button>
                    </div>
                </div>
            </div>
            
            <!-- Inventory View -->
            <div id="view-inventory" class="app-view hidden">
                <div class="flex justify-between items-center mb-4">
                    <button class="btn-back bg-gray-600 text-white py-2 px-4 rounded-md shadow hover:bg-gray-700">&larr; Back to Home</button>
                    <h2 class="text-2xl font-semibold text-gray-800">Full Inventory (All Units)</h2>
                    <button id="export-inventory-csv" class="bg-gray-600 text-white py-2 px-4 rounded-md shadow hover:bg-gray-700">Export CSV</button>
                </div>
                
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Medication</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expires</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- JS will render rows here -->
                            <tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Loading inventory...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reports View -->
            <div id="view-reports" class="app-view hidden">
                <div class="flex justify-between items-center mb-4">
                    <button class="btn-back bg-gray-600 text-white py-2 px-4 rounded-md shadow hover:bg-gray-700">&larr; Back to Home</button>
                    <h2 class="text-2xl font-semibold text-gray-800">Transaction Log</h2>
                    <button id="export-reports-csv" class="bg-gray-600 text-white py-2 px-4 rounded-md shadow hover:bg-gray-700">Export CSV</button>
                </div>

                <!-- Date Filters -->
                <div class="flex flex-wrap gap-4 mb-4 p-4 bg-white rounded-lg shadow-sm">
                    <div>
                        <label for="report-date-start" class="block text-sm font-medium text-gray-700">Start Date</label>
                        <input type="date" id="report-date-start" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="report-date-end" class="block text-sm font-medium text-gray-700">End Date</label>
                        <input type="date" id="report-date-end" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <button id="filter-reports-btn" class="self-end bg-blue-600 text-white py-2 px-4 rounded-md shadow hover:bg-blue-700">Filter</button>
                </div>

                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty Change</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient Ref</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                            </tr>
                        </thead>
                        <tbody id="reports-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- JS will render rows here -->
                            <tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading transactions...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admin View -->
            <div id="view-admin" class="app-view hidden space-y-6">
                <button class="btn-back mb-4 bg-gray-600 text-white py-2 px-4 rounded-md shadow hover:bg-gray-700">&larr; Back to Home</button>
                <h2 class="text-2xl font-semibold text-gray-800">Admin</h2>
                
                <!-- Manage Locations -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Manage Locations</h3>
                    <form id="form-add-location" class="mb-4 flex gap-2">
                        <input type="text" id="location-name" placeholder="New Location Name (e.g., A-1-1)" class="flex-grow block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        <select id="location-temp" class="block px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            <option value="room">Room Temp</option>
                            <option value="fridge">Fridge</option>
                        </select>
                        <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-md shadow hover:bg-blue-700">Add</button>
                    </form>
                    
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Temp</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location ID</th>
                                </tr>
                            </thead>
                            <tbody id="locations-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- JS will render rows here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Other Admin sections (Users, Providers) would go here -->
            </div>

        </div>
    </div>
    
    <!-- Info Modal -->
    <div id="info-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title" class="modal-title"></h3>
                <span id="modal-close-btn" class="modal-close">&times;</span>
            </div>
            <p id="modal-message" class="py-4"></p>
            <div class="flex justify-end pt-4 border-t">
                <button id="modal-ok-btn" class="bg-blue-600 text-white py-2 px-6 rounded-md shadow hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirm-modal-title" class="modal-title">Please Confirm</h3>
                <span id="confirm-modal-close-btn" class="modal-close">&times;</span>
            </div>
            <p id="confirm-modal-message" class="py-4"></p>
            <div class="flex justify-end pt-4 border-t gap-3">
                <button id="confirm-modal-cancel-btn" class="bg-gray-500 text-white py-2 px-6 rounded-md shadow hover:bg-gray-600">Cancel</button>
                <button id="confirm-modal-ok-btn" class="bg-red-600 text-white py-2 px-6 rounded-md shadow hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Print Label Modal -->
    <div id="print-label-modal" class="modal" style="display: none;">
        <div class="modal-content max-w-sm"> <!-- Smaller modal for label -->
            <div class="modal-header">
                <h3 class="modal-title">Print Unit Label</h3>
                <span id="print-label-close-btn" class="modal-close">&times;</span>
            </div>
            
            <!-- This is the content that will be printed -->
            <div id="print-label-content" class="py-4">
                <p class="text-center text-gray-600 mb-4">A new unit was created. Please print and apply this label.</p>
                <!-- 2x1 Inch Label Simulation -->
                <div class="w-full h-auto p-2 border-2 border-dashed border-gray-400 bg-white">
                    <div class="flex flex-row gap-2">
                        <!-- QR Code -->
                        <div id="label-qr-code" class="w-[100px] h-[100px] flex-shrink-0">
                            <!-- QR code will be generated here -->
                        </div>
                        <!-- Human-readable text -->
                        <div class="flex flex-col justify-center flex-grow overflow-hidden">
                            <strong id="label-med-name" class="block text-lg font-bold text-black truncate"></strong>
                            <span id="label-exp-qty" class="block text-sm text-black"></span>
                            <span id="label-loc-id" class="block text-xs text-gray-700 mt-1"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="print-label-modal-footer" class="flex justify-between items-center pt-4 border-t">
                <button id="print-label-done-btn" class="bg-gray-500 text-white py-2 px-6 rounded-md shadow hover:bg-gray-600">Done</button>
                <button id="print-label-print-btn" class="bg-blue-600 text-white py-2 px-6 rounded-md shadow hover:bg-blue-700">Print</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs,
            serverTimestamp,
            writeBatch,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE ---
        let db, auth, userId;
        let locations = [], lots = [], units = [], transactions = [];
        let currentScannedUnit = null; // Store the last successfully scanned unit
        let currentQrCode = null; // Store the QRCode.js instance
        let onConfirmCallback = null; 
        let appInitialized = false; // App status flag

        // --- FIRESTORE COLLECTION REFS ---
        let locationsRef, lotsRef, unitsRef, transactionsRef, ndcFormularyRef; // Added ndcFormularyRef

        // --- FIREBASE & AUTH INITIALIZATION ---

        // ========================================================================
        // START FIREBASE CONFIGURATION
        // ========================================================================
        //
        // STEP 1: Go to https://firebase.google.com/ and create a new project.
        // STEP 2: In your project, click "Add app" and select the Web icon (</>).
        // STEP 3: Give it a nickname (e.g., "DaanaRX App") and register the app.
        // STEP 4: Firebase will give you a 'firebaseConfig' object.
        //         Copy and paste that object here, replacing this placeholder.
        //
        const firebaseConfig = {
            apiKey: "AIzaSyD_XSYIaZF2l5FIVrwLn0TxwHGx2vk1w30",
            authDomain: "daanarx-a.firebaseapp.com",
            projectId: "daanarx-a",
            storageBucket: "daanarx-a.firebasestorage.app",
            messagingSenderId: "82771122027",
            appId: "1:82771122027:web:6dd919fc4e8a199c899e2e",
            measurementId: "G-0JH1LWE1RQ"
        };
        //
        // ========================================================================
        // END FIREBASE CONFIGURATION
        // ========================================================================


        function initialize() {
            const statusEl = document.getElementById('app-status');
            statusEl.textContent = "Connecting...";

            if (firebaseConfig.apiKey === "YOUR_API_KEY_HERE") {
                console.error("Firebase config is missing.");
                showModal("Configuration Needed", "Welcome to DaanaRX! To connect to your database, you must first set up a free Firebase project and paste the configuration keys into the 'inventory.html' file. Please follow the steps in the script comments.");
                statusEl.textContent = "Offline (Not Configured)";
                appInitialized = false;
                // Disable all form buttons if not configured
                document.querySelectorAll('form button[type="submit"]').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('btn-disabled');
                    btn.title = "Please configure Firebase to enable this feature.";
                });
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                setupAuthListener();
                appInitialized = true;
                statusEl.textContent = "Connecting to auth...";

            } catch (e) {
                console.error("Firebase Initialization Error:", e);
                showModal("Firebase Error", "Could not initialize Firebase. Check the console (F12) for details and make sure your config keys are correct.");
                statusEl.textContent = "Error";
                appInitialized = false;
            }
        }

        async function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('app-status').textContent = "Online";

                    // Setup collection references
                    locationsRef = collection(db, 'locations');
                    lotsRef = collection(db, 'lots');
                    unitsRef = collection(db, 'units');
                    transactionsRef = collection(db, 'transactions');
                    ndcFormularyRef = collection(db, 'ndc_formulary'); // Initialize new ref
                    
                    // Start data listeners
                    listenToLocations();
                    listenToLots();
                    listenToUnits();
                    listenToTransactions();
                    
                } else {
                    // No user, sign in anonymously
                    try {
                        document.getElementById('app-status').textContent = "Authenticating...";
                        await signInAnonymously(auth);
                        // The onAuthStateChanged listener will fire again once signed in
                    } catch (error) {
                        console.error("Authentication Error:", error);
                        showModal("Auth Error", "Could not sign in: " + error.message + ". Check Firebase Auth settings.");
                        document.getElementById('app-status').textContent = "Auth Error";
                    }
                }
            });
        }

        // --- REAL-TIME DATA LISTENERS ---
        function listenToLocations() {
            if (!appInitialized) return;
            onSnapshot(locationsRef, (snapshot) => {
                const locationsTableBody = document.getElementById('locations-table-body');
                locationsTableBody.innerHTML = '';
                locations = [];
                if (snapshot.empty) {
                    locationsTableBody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">No locations found. Add one!</td></tr>';
                }
                snapshot.forEach(doc => {
                    const location = { id: doc.id, ...doc.data() };
                    locations.push(location);
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${location.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${location.temp_type}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${location.id}</td>
                        </tr>
                    `;
                    locationsTableBody.innerHTML += row;
                });
                renderLocationOptions();
            }, (error) => {
                console.error("Error listening to locations: ", error);
                showModal("Firestore Error", "Could not read locations. Check security rules and console (F12).");
            });
        }
        
        function listenToLots() {
            if (!appInitialized) return;
            onSnapshot(lotsRef, (snapshot) => {
                lots = [];
                const lotSelect = document.getElementById('unit-lot-id');
                lotSelect.innerHTML = '<option value="">-- Select a Lot --</option>'; // Reset
                snapshot.forEach(doc => {
                    const lot = { id: doc.id, ...doc.data() };
                    lots.push(lot);
                    const option = document.createElement('option');
                    option.value = lot.id;
                    option.textContent = `Lot ${lot.id.substring(0, 6)}... (Source: ${lot.source_donor}, Date: ${lot.date_received})`;
                    lotSelect.appendChild(option);
                });
            }, (error) => {
                console.error("Error listening to lots: ", error);
            });
        }
        
        function listenToUnits() {
            if (!appInitialized) return;
            onSnapshot(unitsRef, (snapshot) => {
                units = [];
                snapshot.forEach(doc => {
                    units.push({ id: doc.id, ...doc.data() });
                });
                renderInventoryTable();
                updateStatusDashboard();
            }, (error) => {
                console.error("Error listening to units: ", error);
            });
        }
        
        function listenToTransactions() {
            if (!appInitialized) return;
            onSnapshot(transactionsRef, (snapshot) => {
                transactions = [];
                snapshot.forEach(doc => {
                    transactions.push({ id: doc.id, ...doc.data() });
                });
                // Render with default (no) filters
                filterAndRenderTransactions();
                updateStatusDashboard();
            }, (error) => {
                console.error("Error listening to transactions: ", error);
            });
        }

        // --- RENDERING FUNCTIONS ---
        function renderLocationOptions() {
            const locSelect = document.getElementById('unit-location');
            locSelect.innerHTML = '<option value="">-- Select a Location --</option>';
            locations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc.id;
                option.textContent = `${loc.name} (${loc.temp_type})`;
                locSelect.appendChild(option);
            });
        }
        
        function renderInventoryTable() {
            const inventoryTableBody = document.getElementById('inventory-table-body');
            inventoryTableBody.innerHTML = '';
            if (units.length === 0) {
                inventoryTableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No units in stock.</td></tr>';
                return;
            }
            
            // Sort by med name, then exp date (FEFO)
            const sortedUnits = units.sort((a, b) => {
                if (a.med_generic < b.med_generic) return -1;
                if (a.med_generic > b.med_generic) return 1;
                if (a.exp_date < b.exp_date) return -1;
                if (a.exp_date > b.exp_date) return 1;
                return 0;
            });

            sortedUnits.forEach(unit => {
                const locName = locations.find(l => l.id === unit.location_id)?.name || 'N/A';
                const isQuarantined = unit.status === 'quarantined';
                const row = `
                    <tr class="hover:bg-gray-50 ${isQuarantined ? 'bg-red-50' : ''}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${unit.med_generic} ${unit.strength} ${unit.form}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${unit.unit_id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${unit.qty_total}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${isQuarantined ? 'text-red-600' : 'text-gray-500'}">${unit.status}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${locName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${unit.exp_date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <button data-unit-id="${unit.id}" class="btn-quarantine text-red-600 hover:text-red-800" ${isQuarantined ? 'disabled' : ''}>
                                ${isQuarantined ? 'Quarantined' : 'Quarantine'}
                            </button>
                        </td>
                    </tr>
                `;
                inventoryTableBody.innerHTML += row;
            });
        }
        
        // Filter and render transactions based on date
        function filterAndRenderTransactions() {
            const reportsTableBody = document.getElementById('reports-table-body');
            reportsTableBody.innerHTML = '';
            
            const startDate = document.getElementById('report-date-start').value;
            const endDate = document.getElementById('report-date-end').value;

            // Create Date objects for comparison. Add 1 day to end date to include the whole day.
            const start = startDate ? new Date(startDate) : null;
            const end = endDate ? new Date(endDate) : null;
            if (end) end.setDate(end.getDate() + 1);

            const filteredTxns = transactions.filter(txn => {
                if (!txn.timestamp) return false; // Guard against incomplete data
                const txnDate = txn.timestamp.toDate();
                if (start && txnDate < start) return false;
                if (end && txnDate >= end) return false;
                return true;
            });

            if (filteredTxns.length === 0) {
                reportsTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No transactions found for this period.</td></tr>';
                return;
            }

            // Sort by timestamp descending (newest first)
            filteredTxns.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());

            filteredTxns.forEach(txn => {
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${txn.timestamp.toDate().toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${txn.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${txn.unit_id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${txn.qty || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${txn.patient_ref || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${txn.reason_note || ''}</td>
                    </tr>
                `;
                reportsTableBody.innerHTML += row;
            });
        }

        function updateStatusDashboard() {
            // Stat 1: In Stock
            const inStockCount = units.filter(u => u.status === 'in_stock' || u.status === 'partial').length;
            document.getElementById('stat-in-stock').textContent = inStockCount;

            // Stat 2: Expiring Soon
            const now = new Date();
            const ninetyDaysFromNow = new Date(new Date().setDate(now.getDate() + 90));
            const expiringCount = units.filter(u => {
                if (!u.exp_date) return false;
                const expDate = new Date(u.exp_date);
                return (u.status === 'in_stock' || u.status === 'partial') && expDate <= ninetyDaysFromNow;
            }).length;
            document.getElementById('stat-expiring').textContent = expiringCount;

            // Stat 3: Checked Out Today
            const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
            const checkedOutCount = transactions.filter(t => {
                return t.type === 'check_out' && t.timestamp && t.timestamp.toDate() >= twentyFourHoursAgo;
            }).length;
            document.getElementById('stat-checked-out').textContent = checkedOutCount;
        }

        // --- EVENT HANDLERS & ACTIONS ---

        // --- SCAN / LOOKUP ---
        async function handleScanLookup() {
            if (!appInitialized) return;
            const scanInput = document.getElementById('scan-input').value.trim();
            if (!scanInput) return;
            
            const q = query(unitsRef, where("unit_id", "==", scanInput));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                // Not found
                document.getElementById('scan-result-found').classList.add('hidden');
                document.getElementById('scan-result-not-found').classList.remove('hidden');
                document.getElementById('scan-error-msg').textContent = `Unit ID "${scanInput}" not found.`;
                currentScannedUnit = null;
            } else {
                // Found
                const doc = querySnapshot.docs[0];
                currentScannedUnit = { id: doc.id, ...doc.data() };
                
                document.getElementById('scan-result-not-found').classList.add('hidden');
                document.getElementById('scan-result-found').classList.remove('hidden');
                
                // Populate data
                document.getElementById('scan-found-med').textContent = `${currentScannedUnit.med_generic} ${currentScannedUnit.strength} ${currentScannedUnit.form}`;
                document.getElementById('scan-found-qty').textContent = currentScannedUnit.qty_total;
                document.getElementById('scan-found-status').textContent = currentScannedUnit.status;
                document.getElementById('scan-found-exp').textContent = currentScannedUnit.exp_date;
                const loc = locations.find(l => l.id === currentScannedUnit.location_id)?.name || 'N/A';
                document.getElementById('scan-found-loc').textContent = loc;

                // Update contextual button states
                const checkoutBtn = document.getElementById('btn-scan-found-checkout');
                if ((currentScannedUnit.status === 'in_stock' || currentScannedUnit.status === 'partial')) {
                    checkoutBtn.disabled = false;
                    checkoutBtn.classList.remove('btn-disabled');
                } else {
                    checkoutBtn.disabled = true;
                    checkoutBtn.classList.add('btn-disabled');
                }
            }
        }

        // --- ADMIN ---
        async function handleAddLocation(e) {
            e.preventDefault();
            if (!appInitialized) return;
            const form = e.target;
            const btn = form.querySelector('button');
            btn.disabled = true;

            const locData = {
                name: form.elements['location-name'].value,
                temp_type: form.elements['location-temp'].value,
                is_active: true
            };
            
            try {
                await addDoc(locationsRef, locData);
                showModal("Success", `Location "${locData.name}" added.`);
                form.reset();
            } catch (error) {
                console.error("Error adding location: ", error);
                showModal("Error", "Could not add location: " + error.message + ". Check Firestore security rules.");
            } finally {
                btn.disabled = false;
            }
        }
        
        // --- CHECK IN ---

        // Helper functions to manage the read-only state of med fields
        function lockMedFields() {
            const fields = ['unit-generic-name', 'unit-strength', 'unit-form', 'unit-brand-name', 'unit-ndc'];
            fields.forEach(id => {
                const el = document.getElementById(id);
                el.readOnly = true;
                el.classList.add('bg-gray-50');
                el.classList.remove('bg-white');
            });
        }
        
        function unlockMedFields() {
            const fields = ['unit-generic-name', 'unit-strength', 'unit-form', 'unit-brand-name', 'unit-ndc'];
            fields.forEach(id => {
                const el = document.getElementById(id);
                el.readOnly = false;
                el.classList.remove('bg-gray-50');
                el.classList.add('bg-white');
            });
            document.getElementById('unit-generic-name').focus();
        }
        
        // Helper function to clear form
        function clearNdcForm() {
            document.getElementById('unit-generic-name').value = '';
            document.getElementById('unit-brand-name').value = '';
            document.getElementById('unit-strength').value = '';
            document.getElementById('unit-form').value = '';
            document.getElementById('unit-ndc').value = '';
        }

        // Helper function to show/hide fallback
        function showFallback(show) {
            document.getElementById('ndc-fallback-search').classList.toggle('hidden', !show);
            if(show) {
                document.getElementById('ndc-name-search').focus();
            } else {
                document.getElementById('ndc-name-search').value = '';
                document.getElementById('ndc-search-chips').innerHTML = '';
            }
        }

        // Helper function to auto-fill form
        function autoFillNdcForm(drug, ndc, source) {
            document.getElementById('unit-generic-name').value = drug.med_generic || drug.genericName || 'N/A';
            document.getElementById('unit-brand-name').value = drug.med_brand || drug.brandName || 'N/A';
            document.getElementById('unit-strength').value = drug.strength || 'N/A';
            document.getElementById('unit-form').value = drug.form || 'N/A';
            document.getElementById('unit-ndc').value = ndc;

            const statusEl = document.getElementById('ndc-lookup-status');
            statusEl.textContent = `Found: ${drug.med_brand || drug.brandName} (${source === 'local' ? 'Local DB' : 'openFDA'})`;
            statusEl.classList.remove('text-red-600', 'text-blue-600');
            statusEl.classList.add('text-green-600');
            
            document.getElementById('unit-qty').focus();
            lockMedFields();
            showFallback(false); // Hide fallback on success
        }

        async function handleNdcScan() {
            if (!appInitialized) return;
            const ndcInput = document.getElementById('ndc-scan-input');
            const ndc = ndcInput.value.trim();
            if (!ndc) return;

            const statusEl = document.getElementById('ndc-lookup-status');
            statusEl.textContent = 'Searching Local DB...';
            statusEl.classList.remove('text-red-600', 'text-green-600');
            statusEl.classList.add('text-blue-600');
            
            lockMedFields();
            showFallback(false); // Hide fallback during new search

            // 1. Check local formulary
            try {
                const docRef = doc(ndcFormularyRef, ndc); // Use NDC as the document ID
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const drug = docSnap.data();
                    autoFillNdcForm(drug, ndc, 'local');
                    return;
                }
            } catch (e) {
                console.error("Error checking local formulary: ", e);
                // Don't stop, just proceed to openFDA
            }

            // 2. Not in local, check openFDA
            statusEl.textContent = 'Searching openFDA...';
            try {
                const response = await fetch(`https://api.fda.gov/drug/ndc.json?search=product_ndc:"${ndc}"&limit=1`);
                
                if (response.status === 404) {
                     throw new Error('NDC not found in openFDA database.');
                }
                if (!response.ok) {
                    throw new Error(`FDA API Error: ${response.statusText}`);
                }
                
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    const drug = data.results[0];
                    console.log("NDC Data:", drug);

                    const genericName = drug.generic_name || 'N/A';
                    const brandName = drug.brand_name || 'N/A';
                    const form = drug.dosage_form || 'N/A';
                    let strength = 'N/A';
                    if (drug.active_ingredients && drug.active_ingredients.length > 0) {
                        strength = drug.active_ingredients[0].strength;
                    }

                    const drugData = { genericName, brandName, strength, form };
                    autoFillNdcForm(drugData, ndc, 'fda');

                } else {
                    throw new Error('NDC not found in openFDA database.');
                }
            } catch (error) {
                // 3. Not found anywhere
                console.error("Error fetching NDC data: ", error);
                statusEl.textContent = `Error: ${error.message} Try searching by name or enter manually.`;
                statusEl.classList.remove('text-blue-600');
                statusEl.classList.add('text-red-600');
                
                clearNdcForm();
                document.getElementById('unit-ndc').value = ndc; // Keep the NDC they typed
                showFallback(true); // Show the friendly fallback
            }
        }
        
        async function handleFriendlyNameSearch(e) {
            const searchTerm = e.target.value.trim().toLowerCase();
            const chipsContainer = document.getElementById('ndc-search-chips');
            
            if (searchTerm.length < 3) {
                chipsContainer.innerHTML = '';
                return;
            }

            // Firestore "starts-with" query. Note: Case-sensitive, so we use a trick.
            // This is tricky. A simple starts-with is `where("med_generic", ">=", searchTerm)`.
            // A true "contains" requires a 3rd party search like Algolia.
            // Let's do a simple, case-insensitive "starts-with" by searching on a lowercase field.
            // But we didn't save a lowercase field.
            // Let's stick to a simple query for now.
            // User must type "Fluoxetine", not "fluoxetine"
            
            try {
                // Query for "starts-with"
                const q = query(ndcFormularyRef, 
                    where("med_generic", ">=", searchTerm), 
                    where("med_generic", "<=", searchTerm + '\uf8ff')
                );
                
                const querySnapshot = await getDocs(q);
                chipsContainer.innerHTML = ''; // Clear old chips
                
                if (querySnapshot.empty) {
                    chipsContainer.innerHTML = '<span class="text-sm text-gray-500">No local matches.</span>';
                    return;
                }

                querySnapshot.forEach(doc => {
                    const drug = doc.data();
                    const chip = document.createElement('button');
                    chip.type = 'button';
                    chip.className = 'ndc-chip';
                    chip.textContent = `${drug.med_generic} ${drug.strength} ${drug.form}`;
                    // Store the data on the chip itself
                    chip.dataset.drug = JSON.stringify(drug);
                    chip.dataset.ndc = drug.ndc;
                    chipsContainer.appendChild(chip);
                });

            } catch (e) {
                console.error("Error searching formulary: ", e);
                chipsContainer.innerHTML = '<span class="text-sm text-red-500">Error searching.</span>';
            }
        }

        function handleChipClick(e) {
            if (e.target.classList.contains('ndc-chip')) {
                const drugData = JSON.parse(e.target.dataset.drug);
                const ndc = e.target.dataset.ndc;
                
                autoFillNdcForm(drugData, ndc, 'local');
                showFallback(false);
            }
        }

        function handleEnterManually() {
            unlockMedFields();
            showFallback(false);
        }

        async function handleAddLot(e) {
            e.preventDefault();
            if (!appInitialized) return;
            const form = e.target;
            const btn = form.querySelector('button');
            btn.disabled = true;

            const lotData = {
                date_received: form.elements['lot-date'].value,
                source_donor: form.elements['lot-source'].value,
                notes: form.elements['lot-notes'].value,
                received_by_user_id: userId,
                created_at: serverTimestamp()
            };
            
            try {
                const docRef = await addDoc(lotsRef, lotData);
                showModal("Success", `Lot created successfully.`);
                // Auto-select this new lot in the next step
                document.getElementById('unit-lot-id').value = docRef.id;
                form.reset();
            } catch (error) {
                console.error("Error adding lot: ", error);
                showModal("Error", "Could not add lot: " + error.message);
            } finally {
                btn.disabled = false;
            }
        }
        
        async function handleAddUnit(e) {
            e.preventDefault();
            if (!appInitialized) return;
            const form = e.target;
            const btn = form.querySelector('button');
            btn.disabled = true;
            
            const locName = locations.find(l => l.id === form.elements['unit-location'].value)?.name || 'N/A';
            const isManualEntry = !document.getElementById('unit-generic-name').readOnly;
            const ndc = form.elements['unit-ndc'].value.trim();

            const unitData = {
                unit_id: `UNIT-${Date.now()}`, // Simple unique ID for proto
                lot_id: form.elements['unit-lot-id'].value,
                med_generic: form.elements['unit-generic-name'].value,
                med_brand: form.elements['unit-brand-name'].value,
                strength: form.elements['unit-strength'].value,
                form: form.elements['unit-form'].value,
                ndc: ndc,
                qty_total: parseInt(form.elements['unit-qty'].value, 10),
                exp_date: form.elements['unit-exp'].value,
                location_id: form.elements['unit-location'].value,
                location_name: locName, // Denormalize for the label
                status: 'in_stock',
                created_at: serverTimestamp(),
                updated_at: serverTimestamp(),
                qr_code_value: ""
            };
            
            unitData.qr_code_value = JSON.stringify({
                u: unitData.unit_id,
                l: unitData.lot_id.substring(0, 10),
                g: unitData.med_generic,
                s: unitData.strength,
                f: unitData.form,
                x: unitData.exp_date,
                loc: locName
            });

            try {
                const batch = writeBatch(db);
                // Create a new document reference in the 'units' collection
                const unitRef = doc(unitsRef); 
                batch.set(unitRef, unitData);
                
                // Create a new document reference in the 'transactions' collection
                const txnRef = doc(transactionsRef);
                batch.set(txnRef, {
                    unit_id: unitData.unit_id,
                    type: 'check_in',
                    qty: unitData.qty_total,
                    by_user_id: userId,
                    reason_note: 'Initial stock check-in',
                    timestamp: serverTimestamp()
                });

                // --- SAVE TO LOCAL FORMULARY ---
                // If this was a manual entry and they provided an NDC, save it
                if (isManualEntry && ndc) {
                    const ndcDocRef = doc(ndcFormularyRef, ndc); // Use NDC as ID
                    const ndcData = {
                        med_generic: unitData.med_generic,
                        med_brand: unitData.med_brand,
                        strength: unitData.strength,
                        form: unitData.form,
                        ndc: unitData.ndc,
                        last_updated: serverTimestamp()
                    };
                    // Use set with merge to create or update the NDC record
                    batch.set(ndcDocRef, ndcData, { merge: true });
                }
                // --- END SAVE TO FORMULARY ---

                await batch.commit();
                showPrintLabelModal(unitData);
                form.reset();
                document.getElementById('ndc-scan-input').value = '';
                document.getElementById('ndc-lookup-status').textContent = '';
                lockMedFields(); // Re-lock fields for the next entry
                document.getElementById('unit-lot-id').value = unitData.lot_id;
                showFallback(false);
            } catch (error) {
                console.error("Error adding unit: ", error);
                showModal("Error", "Could not add unit: " + error.message);
            } finally {
                btn.disabled = false;
            }
        }
        
        // --- CHECK OUT ---
        async function handleCheckOut(e) {
            e.preventDefault();
            if (!appInitialized) return;
            const form = e.target;
            const btn = form.querySelector('button');
            btn.disabled = true;

            const unitIdToFind = form.elements['checkout-unit-id'].value.trim();
            const qtyToDispense = parseInt(form.elements['checkout-qty'].value, 10);
            const patientRef = form.elements['checkout-patient-ref'].value;
            const reason = form.elements['checkout-reason'].value;

            // --- Find Unit to Check Out ---
            let unit = units.find(u => u.unit_id === unitIdToFind);
            let docId = unit?.id;

            if (!unit) {
                const q = query(unitsRef, where("unit_id", "==", unitIdToFind));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    showModal("Error", "Unit ID not found.");
                    btn.disabled = false;
                    return;
                }
                const doc = querySnapshot.docs[0];
                unit = doc.data();
                docId = doc.id;
            }

            // --- Validation Checks ---
            if (qtyToDispense <= 0) {
                showModal("Error", "Quantity must be greater than 0.");
                btn.disabled = false;
                return;
            }

            if (unit.status === 'dispensed' || unit.status === 'discarded' || unit.status === 'expired' || unit.status === 'quarantined') {
                showModal("Error", `Cannot dispense. Unit status is: ${unit.status}.`);
                btn.disabled = false;
                return;
            }
            
            const newQty = unit.qty_total - qtyToDispense;
            if (newQty < 0) {
                showModal("Error", `Cannot dispense. Requested ${qtyToDispense}, but only ${unit.qty_total} available.`);
                btn.disabled = false;
                return;
            }
            
            // --- FEFO Check ---
            const olderUnit = units.find(u => 
                u.id !== docId &&
                u.med_generic === unit.med_generic &&
                u.strength === unit.strength &&
                (u.status === 'in_stock' || u.status === 'partial') &&
                u.exp_date < unit.exp_date
            );

            // --- Define the core checkout logic ---
            const proceedWithCheckout = async () => {
                try {
                    const batch = writeBatch(db);
                    
                    const unitRef = doc(db, 'units', docId);
                    const newStatus = newQty === 0 ? 'dispensed' : 'partial';
                    batch.update(unitRef, {
                        qty_total: newQty,
                        status: newStatus,
                        updated_at: serverTimestamp()
                    });
                    
                    const txnRef = doc(transactionsRef);
                    batch.set(txnRef, {
                        unit_id: unit.unit_id,
                        type: 'check_out',
                        qty: qtyToDispense,
                        by_user_id: userId,
                        patient_ref: patientRef,
                        reason_note: reason,
                        timestamp: serverTimestamp()
                    });

                    await batch.commit();

                    showModal("Success", `Dispensed ${qtyToDispense} from ${unit.unit_id}. New quantity: ${newQty}.`);
                    form.reset();
                } catch (error) {
                    console.error("Error checking out: ", error);
                    showModal("Error", "Could not dispense item: " + error.message);
                } finally {
                    btn.disabled = false;
                }
            };
            
            // --- Execute FEFO check or proceed ---
            if (olderUnit) {
                // FEFO Warning!
                const warningTitle = "FEFO Warning";
                const warningMsg = `This unit expires on ${unit.exp_date}. An older unit (exp: ${olderUnit.exp_date}) is available. Proceed anyway?`;
                // Change confirm button to blue for "Proceed"
                document.getElementById('confirm-modal-ok-btn').classList.remove('bg-red-600', 'hover:bg-red-700');
                document.getElementById('confirm-modal-ok-btn').classList.add('bg-blue-600', 'hover:bg-blue-700');
                document.getElementById('confirm-modal-ok-btn').textContent = "Proceed";

                showConfirmModal(warningTitle, warningMsg, () => {
                    proceedWithCheckout();
                });
                // Need to re-enable button if they cancel
                btn.disabled = false; 
            } else {
                // No FEFO conflict, proceed immediately
                await proceedWithCheckout();
            }
        }
        
        // --- INVENTORY ACTIONS ---
        async function handleQuarantineUnit(docId) {
            if (!appInitialized) return;
            const unit = units.find(u => u.id === docId);
            if (!unit) return;

            const note = "Manual quarantine by user.";

            try {
                const batch = writeBatch(db);
                
                const unitRef = doc(db, 'units', docId);
                batch.update(unitRef, {
                    status: 'quarantined',
                    updated_at: serverTimestamp()
                });
                
                const txnRef = doc(transactionsRef);
                batch.set(txnRef, {
                    unit_id: unit.unit_id,
                    type: 'adjust',
                    by_user_id: userId,
                    reason_note: `QUARANTINE: ${note}`,
                    timestamp: serverTimestamp()
                });

                await batch.commit();
                showModal("Success", `Unit ${unit.unit_id} has been quarantined.`);
            } catch (error) {
                console.error("Error quarantining unit: ", error);
                showModal("Error", "Could not quarantine unit: " + error.message);
            }
        }
        
        // --- REPORTS ---
        function handleFilterReports() {
            filterAndRenderTransactions();
        }

        // --- CSV EXPORT ---
        function exportToCSV(data, filename) {
            if (data.length === 0) {
                showModal("Info", "No data to export.");
                return;
            }
            
            const headers = Object.keys(data[0]);
            let csvContent = headers.join(",") + "\n";

            data.forEach(row => {
                const values = headers.map(header => {
                    let cell = row[header];
                    // Format Firestore Timestamps
                    if (typeof cell === 'object' && cell !== null && cell.toDate) {
                        cell = cell.toDate().toISOString();
                    }
                    // Escape strings
                    if (typeof cell === 'string') {
                        cell = `"${cell.replace(/"/g, '""')}"`;
                    }
                    return cell;
                });
                csvContent += values.join(",") + "\n";
            });

            downloadCSV(csvContent, filename);
        }
        
        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        // --- MODALS & NAVIGATION ---
        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('info-modal').style.display = 'flex';
        }
        
        function closeModal() {
            document.getElementById('info-modal').style.display = 'none';
        }

        function showConfirmModal(title, message, callback) {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-message').textContent = message;
            document.getElementById('confirm-modal').style.display = 'flex';
            
            // Reset confirm button to default red
            const okBtn = document.getElementById('confirm-modal-ok-btn');
            okBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            okBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            okBtn.textContent = "Confirm";
            
            onConfirmCallback = callback;
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').style.display = 'none';
            onConfirmCallback = null;
        }

      function showPrintLabelModal(unitData) {
            document.getElementById('label-med-name').textContent = `${unitData.med_generic} ${unitData.strength} ${unitData.form}`;
            document.getElementById('label-exp-qty').textContent = `Exp ${unitData.exp_date} Qty ${unitData.qty_total}`;
            document.getElementById('label-loc-id').textContent = `${unitData.location_name}  ${unitData.unit_id}`;
            
            const qrCodeEl = document.getElementById('label-qr-code');
            qrCodeEl.innerHTML = ''; // Clear previous QR code

            // Create new QR code
            try {
                currentQrCode = new QRCode(qrCodeEl, {
                    text: unitData.qr_code_value,
                    width: 100,
                    height: 100,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.L
                });
            } catch (e) {
                console.error("Error generating QR code:", e);
                qrCodeEl.innerHTML = "Error generating QR code.";
            }

            document.getElementById('print-label-modal').style.display = 'flex';
        }

        function closePrintLabelModal() {
            document.getElementById('print-label-modal').style.display = 'none';
            const qrCodeEl = document.getElementById('label-qr-code');
            qrCodeEl.innerHTML = '';
            currentQrCode = null;
        }

        function printLabel() {
            window.print();
        }

        function showView(viewId) {
            document.querySelectorAll('.app-view').forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            
            // Clear scan results when navigating away
            if (viewId !== 'view-scan') {
                document.getElementById('scan-input').value = '';
                document.getElementById('scan-result-found').classList.add('hidden');
                document.getElementById('scan-result-not-found').classList.add('hidden');
                currentScannedUnit = null;
            }
            // Reset med fields when navigating to check-in
            if (viewId === 'view-check-in') {
                lockMedFields();
                document.getElementById('ndc-lookup-status').textContent = '';
                document.getElementById('form-add-unit').reset();
                showFallback(false);
            }
        }

        // --- ATTACH LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            // Render icons
            try {
                const createIcon = (name) => React.createElement(lucide[name]);
                ReactDOM.render(createIcon('PackagePlus'), document.getElementById('icon-check-in'));
                ReactDOM.render(createIcon('PackageMinus'), document.getElementById('icon-check-out'));
                ReactDOM.render(createIcon('ScanLine'), document.getElementById('icon-scan'));
                ReactDOM.render(createIcon('Boxes'), document.getElementById('icon-inventory'));
                ReactDOM.render(createIcon('BarChart3'), document.getElementById('icon-reports'));
                ReactDOM.render(createIcon('Settings'), document.getElementById('icon-admin'));
            } catch (e) {
                console.error("Error rendering icons. This might be due to a script blocker.", e);
                // Don't halt the script, let other listeners attach
            }

            // Navigation
            document.getElementById('nav-check-in').addEventListener('click', () => showView('view-check-in'));
            document.getElementById('nav-check-out').addEventListener('click', () => showView('view-check-out'));
            document.getElementById('nav-scan').addEventListener('click', () => showView('view-scan'));
            document.getElementById('nav-inventory').addEventListener('click', () => showView('view-inventory'));
            document.getElementById('nav-reports').addEventListener('click', () => showView('view-reports'));
            document.getElementById('nav-admin').addEventListener('click', () => showView('view-admin'));
            
            document.querySelectorAll('.btn-back').forEach(btn => {
                btn.addEventListener('click', () => showView('view-home'));
            });

            // Form Submissions
            document.getElementById('form-add-location').addEventListener('submit', handleAddLocation);
            document.getElementById('form-add-lot').addEventListener('submit', handleAddLot);
            document.getElementById('form-add-unit').addEventListener('submit', handleAddUnit);
            document.getElementById('form-check-out').addEventListener('submit', handleCheckOut);
            
            // NDC Scan listener
            document.getElementById('btn-ndc-lookup').addEventListener('click', handleNdcScan);

            // Friendly Fallback Listeners
            document.getElementById('ndc-name-search').addEventListener('input', handleFriendlyNameSearch);
            document.getElementById('ndc-search-chips').addEventListener('click', handleChipClick);
            document.getElementById('btn-enter-manually').addEventListener('click', handleEnterManually);

            // Scan view listeners
            document.getElementById('btn-scan-lookup').addEventListener('click', handleScanLookup);
            document.getElementById('form-scan-lookup').addEventListener('submit', (e) => {
                e.preventDefault();
                handleScanLookup();
            });
            document.getElementById('btn-scan-not-found-checkin').addEventListener('click', () => showView('view-check-in'));
            document.getElementById('btn-scan-found-checkout').addEventListener('click', () => {
                if (currentScannedUnit) {
                    document.getElementById('checkout-unit-id').value = currentScannedUnit.unit_id;
                    showView('view-check-out');
                }
            });

            // Modal close
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
            document.getElementById('modal-ok-btn').addEventListener('click', closeModal);

            // Confirm modal listeners
            document.getElementById('confirm-modal-close-btn').addEventListener('click', closeConfirmModal);
            document.getElementById('confirm-modal-cancel-btn').addEventListener('click', closeConfirmModal);
            document.getElementById('confirm-modal-ok-btn').addEventListener('click', () => {
                if (onConfirmCallback) {
                    onConfirmCallback(); // Execute the stored callback
                }
                closeConfirmModal();
            });

            // Print modal listeners
            document.getElementById('print-label-close-btn').addEventListener('click', closePrintLabelModal);
            document.getElementById('print-label-done-btn').addEventListener('click', closePrintLabelModal);
            document.getElementById('print-label-print-btn').addEventListener('click', printLabel);

            // Inventory & Reports listeners
            document.getElementById('export-inventory-csv').addEventListener('click', () => exportToCSV(units, 'daanarx_inventory.csv'));
            document.getElementById('export-reports-csv').addEventListener('click', () => exportToCSV(transactions, 'daanarx_transactions.csv'));
            document.getElementById('filter-reports-btn').addEventListener('click', handleFilterReports);
            
            // Event delegation for quarantine buttons
            document.getElementById('inventory-table-body').addEventListener('click', e => {
                if (e.target.classList.contains('btn-quarantine')) {
                    const docId = e.target.dataset.unitId;
                    // Use the confirm modal
                    showConfirmModal('Quarantine Unit?', 'Are you sure you want to quarantine this unit?', () => {
                        handleQuarantineUnit(docId);
                    });
                }
            });

            showView('view-home'); // Start at home
            
            // Initialize Firebase
            initialize();
        });
    </script>
</body>
</html>
